/*! umpp 2015-02-28 */
KISSY.add("tbc/umpp/1.4.36/mods/messenger",function(a){function b(a,b){return t.push([a,b])-1}function c(a){return t[a]=null}function d(b,c,d){var e={type:b,content:c},f=d;if(a.isString(d)?(f=m.get("#"+d),d=f.contentWindow):d.contentWindow&&(d=d.contentWindow),i())try{return d.KISSY.TBC.Messenger.fire(b,c)}catch(g){}o?j&&(j.callSWF?j.callSWF("send",[e,h(f)]):j.send(e,h(f))):d.postMessage(n.stringify(e),"*")}function e(b,c){a.each(t,function(a){a&&a[0]===b&&a[1](c)})}function f(b,c){var d,e=(o?"parentFlash="+w+"&childFlash=_MessengerChildFlash_"+a.now()+"&":"")+"domain=taobao.org";a.isString(b)?(d=b,b={}):d=b.src,b.src=d+(d.indexOf("?")>-1?"&":"?")+e;var f=m.create("<iframe>",b);return f.setAttribute("width",1),f.setAttribute("height",1),f.style.position="absolute",m.get(c||"body").appendChild(f)}function g(a,b){u?f(a,b):v.push([a,b])}function h(a){var b=a.src,c=/childFlash=([^&]+)/;if(b){var d=b.match(c);if(d&&d[1])return d[1];throw"iframe has no flashName param"}}function i(){return!1}var j,k=window,l=a.namespace("TBC.Messenger"),m=a.DOM,n=(a.Event,a.UA,a.JSON),o=(document.domain,"undefined"==typeof postMessage||!k.addEventListener),p=-1===location.host.indexOf("daily")&&-1===location.host.indexOf("net"),q="//"+(p?"g.alicdn.com":"assets.daily.taobao.net/g"),r="1.4.36",s=parseFloat(r)?q+"/tbc/umpp/"+r+"/flash-post-message.swf":"flash-post-message.swf",t=[],u=!o,v=[],w="_MessengerFlash_"+a.now();if(!i()||o)if(o){var x=!(a.version<=1.2||a.version>=1.4);a.use(x?"swf":"flash",function(a,b){window._Messenger_Flash_PostMessage=function(a,b){var c=b.type,d=b.msg;if("swfReady"===c){u=!0;for(var g;g=v.pop();)f.apply(null,g)}else"message"==c&&d&&e(d.type,d.content)};var c={src:s,attrs:{width:1,height:1,style:"position:absolute;top:0",id:"umpp-message-id",name:"umpp-message-name"},params:{flashVars:{jsentry:"_Messenger_Flash_PostMessage",swfid:"J_MessengerFlashPostMessage",name:w},allowscriptaccess:"always"}};b&&x?j=new b(c):a.Flash&&a.Flash.add&&a.Flash.add("#J_FlashPostMessageContainer",c,function(a){j=a.swf})})}else k.addEventListener("message",function(b){var c=b.data;if(c&&a.isString(c))try{var d=n.parse(c);e(d.type,d.content)}catch(f){}},!1);else u=!0;return a.mix(l,{register:b,unregister:c,send:d,createIframe:g,fire:e,flashName:w})},{requires:["core"]}),KISSY.add("tbc/umpp/1.4.36/mods/getNick",function(a){var b=a.namespace("TBC.umpp");return b.getNick=function(b){var c=a.Cookie.get("_nk_")||a.Cookie.get("lgc");return b&&c?encodeURIComponent(unescape(c.replace(/\\u/g,"%u"))):c}},{requires:["cookie"]}),KISSY.add("tbc/umpp/1.4.36/mods/trinity",function(a){function b(a,b,c){this.nick=a||"umpp-guest",this.swfurl=b,this.evs=c,this._init()}var c=a.DOM,d=(a.JSON,a.namespace("TBC.umpp")),e="UM_",f=window,g="J_UmppUserContainer",h="_umpp_trinity_",i=b.prototype;return i._init=function(){var b=this,d={src:b.swfurl,attrs:{width:1,height:1,id:"umpp-trinity-id",name:"umpp-trinity-name"},params:{flashVars:{jsentry:h,swfid:e+b.nick+a.now(),group:b.nick},allowscriptaccess:"always"}};f[h]=function(a,c){var d=c.type,e=c.data,f=b.evs,g=f[d];g&&g.call(b,"message"===d?e:null)};var i=!(a.version<=1.2||a.version>=1.4);a.use(i?"swf":"flash",function(a,e){i&&e?b.swf=new e(d):a.Flash&&a.Flash.add&&(c.get("#"+g)||document.body.appendChild(c.create('<div id="'+g+'" style="height:1px;width:1px;overflow:hidden;position:absolute;bottom:1px"></div>')),a.Flash.add("#"+g,d,function(a){b.swf=a.swf}))})},i.fire=function(a,b){return this.swf.callSWF?this.swf.callSWF("fire",[a,b]):(this.swf.fire(a,b),void 0)},i.destroy=function(){var a=this;try{a.swf.destroy?a.swf.destroy():c.remove("#"+g),delete f[h]}catch(b){}},d.Trinity=b},{requires:["dom","json"]}),KISSY.add("tbc/umpp/1.4.36/mods/initGuest",function(a){function b(b,f,g){return e._guestTimer=setTimeout(function(){a.getScript(parseFloat(c)?f+"/tbc/umpp/"+c+"/guest-min.js":"guest.js",function(){parseFloat(a.version,10)>1.1&&a.use(parseFloat(c)?"tbc/umpp/"+c+"/guest":"tbc/umpp/guest")})},d),a.mix(e,{isOnline:b,cdnPath:f,Trinity:g}),e}var c="1.4.36",d=18e4,e=a.namespace("TBC.umpp");return a.mix(e,{register:function(){},send:function(){},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),this._guestTimer&&(clearTimeout(this._guestTimer),this._guestTimer=null)}}),e.initGuest=b}),KISSY.add("tbc/umpp/1.4.36/mods/initUser",function(a){function b(b){var c=/onerror|onload|script|svg|eval|function/gi;if(a.isString(b))return b.replace(c,"_");if(a.isObject(b)){for(var d in b)a.isString(b[1])&&(b[d]=b[d].replace(c,"_"));return b}return a.isArray(b)?(b=a.JSON.stringify(b).replace(c,"_"),a.JSON.parse(b)):b}function c(a){o.get("#"+q)||p.createIframe({src:a,id:q,frameborder:0,scrolling:"no"})}function d(b){a.isArray(b)&&b.length&&a.each(b,function(a){"1063"==a.t1&&u.trinity.fire({content:[a],identity:[u.nick,a.t1,"1"].join("-")})})}function e(){p.register("umppready",function(){m=!0,g("master"),g("join")}),p.register("umppdata",function(b){if(a.isArray(b))for(var c=b.length,e=0;c>e;e++){var f=b[e];f.content&&a.isString(f.content)&&(f.content=f.content.replace(/"/g,v))}u.notify(b,!0),d(b)})}function f(b,c){if(!c)return!1;a.isString(c)&&(c=a.JSON.parse(decodeURI(c)));var d=c.body,e=d.content;if(a.isObject(d))if("-"===d.identity)a.each(e,function(b){a.each(u._Events,function(c){c&&b.t1==c[0]&&(b.content&&a.isString(b.content)&&(b.content=b.content.replace(new RegExp(v,"g"),'"')),c[1](b))})});else if(r===d.type)if(k){var f=e[0],h=e[1];"umpp-store-get"===f?u.getItem(h,function(a){b.fire.call(b,{type:r,content:[h,a]},c.from)}):"umpp-store-remove"===f?u.removeItem.call(u,h):"umpp-store-set"===f?u.setItem.apply(u,h):u.send(f,h)}else{var e=d.content;p.fire("umpp-store-get-"+e[0],e[1])}else if(s===d.type){if(!d.includeSelf&&c.from===c.to)return!1;g("message",d.content)}}function g(b,c){a.each(u._SwfEvents,function(a){a&&b===a[0]&&(a[1](c),"message"!==b&&(a[0]=b+"_ed"))})}function h(a){c("//mpp."+(a?"taobao.com":"daily.taobao.net:8080")+"/ajaxconn2.html?appId="+t),m&&g("master")}function i(b,d,i,j){u.trinity=new b(d,i,{master:function(){k=!0,e(),new a.IO({url:location.protocol+"//allot-mpp."+(j?"taobao.com":"daily.taobao.net")+"/allot.do?appId="+t,dataType:"jsonp",timeout:3,success:function(a){if(a&&0==a.code){var b=a.tn?a[a.tn]:a.token;b&&(b="&"+(a.tn?a.tn:"token")+"="+b),c("//"+a.host+"/ajaxconn2.html?appId="+t+b),m&&g("master")}else a&&1111==a.status&&h(j)},error:function(){h(j)}})},join:function(){l=!0,(k&&m||!k)&&g("join")},message:function(a){f(this,a)}})}function j(a,b,c,d,e){var f=parseFloat(n)?b+"/tbc/umpp/1.4.35/trinity.swf":"trinity.swf";return u.nick=c,i(d,c,f,a),u.on("join",function(){new e({mc:u})}),u}var k,l,m,n="1.4.36",o=a.DOM,p=a.TBC.Messenger,q="J_Um_Iframe",r="_trinity_notify_private",s="_trinity_notify_public",t=-1===location.host.indexOf("meeting.wangwang")?1064:1065,u=a.namespace("TBC.umpp"),v="@1fuck1@";return a.mix(u,{_Events:[],_SwfEvents:[],_StoreCache:{},_storeData:function(a,b){k&&(this._StoreCache[a]=b)},_removeData:function(a){k&&this._StoreCache[a]&&delete this._StoreCache[a]},on:function(a,b){return(k&&m||!k&&l)&&("master"===a&&k||"join"===a&&l)?(b(),!0):this._SwfEvents.push([a,b])-1},off:function(b){return a.isNumber(b)?this._SwfEvents[b]=null:void 0},register:function(a,c,d){var e=this,f=function(f,g){f&&(f=b(f)),c(f,g),d?e._storeData(a,f):e.removeItem(a)};return e.getItem(a,function(a){a&&f(a,!0)}),e._Events.push([a,f])-1},unregister:function(a){return this._Events[a]=null},send:function(a,b){return k?p.send.call(null,a,b,q):(this.trinity&&this.trinity.fire({type:r,content:[a,b]},"_"+this.nick),void 0)},notify:function(a,b){return this.trinity.fire({type:s,content:a,includeSelf:b,identity:"-"})},setItem:function(a,b){var c=this;c.on("join",function(){c._storeData(a,b),c.send("umpp-store-set",[a,b])})},getItem:function(a,b){var c=this,d=this._StoreCache[a];k&&d?b(d):c.on("join",function(){var d=p.register("umpp-store-get-"+a,function(e){p.unregister(d),c._storeData(a,e),b(e)});c.send("umpp-store-get",a)})},removeItem:function(a){var b=this;b.on("join",function(){b._removeData(a),b.send("umpp-store-remove",a)})},clear:function(a){return this.send("clearTMsg",a)},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),o.remove("#"+q),k=void 0,l=void 0,m=void 0,this._StoreCache={}}}),u.initUser=j},{requires:["core"]}),KISSY.add("tbc/umpp/1.4.36/mods/monitorevent",function(a,b){function c(b){this.cfg=a.merge({delay:2e4},b||{}),this.status=1,this._init()}return a.mix(c.prototype,{get:function(a){return this.cfg[a]},set:function(a,b){this.cfg[a]=b},_init:function(){var b=window.g_config;return b?!b.appId||1!=b.appId&&1009!=b.appId?!1:(this.itemId=b.itemId,this.itemId?(this.activeTime=a.now(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,1,this.activeTime].join(",")),this.timer=null,this._bindEvent(),this._addTimer(),this._registerUmppEvent(),void 0):!1):!1},_bindEvent:function(){var a=this;b.on(window,"focus",function(){a._active.call(a),a._focus.call(a)}),b.on(window,"blur",function(){a._active.call(a),a._blur.call(a,!0)}),b.on(window,"mousemove scroll",function(){a._active.call(a)}),b.on(window,"beforeunload",function(){a._close.call(this)})},_registerUmppEvent:function(){var a=this,b=a.cfg.mc;b.register("monitor-start",function(){a.start.call(a)}),b.register("monitor-focustime",function(b){a.set.call(a,"delay",1e3*b.focustime)})},_focus:function(){this.set("focusbluring",!1),this.status&&(this._removeTimer(),this.timer||this._addTimer(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,2,a.now()].join(",")))},_blur:function(b){this.set("focusbluring",!1),this.status&&(b&&this._removeTimer(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,3,a.now()].join(",")))},_active:function(){this.activeTime=a.now()},_close:function(){this.status&&this.cfg.mc.send("umpp-monitor-event",[this.itemId,4,a.now()].join(","))},_addTimer:function(){var b=this;b.timer=setTimeout(function(){var c=a.now();c-b.activeTime>b.cfg.delay&&!b.get("focusbluring")&&(b._blur(),b.set("focusbluring",!0)),b.timer=setTimeout(arguments.callee,b.cfg.delay)},b.cfg.delay)},_removeTimer:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)}}),c},{requires:["event"]}),KISSY.add("tbc/umpp/1.4.36/index",function(a,b,c,d,e,f,g,h){function i(){var b,c=a.Cookie,d=-1===location.host.indexOf("daily"),e=c.get("_l_g_")||c.get("lgc"),f=location.protocol+"//"+(d?"g.alicdn.com":"assets.daily.taobao.net/g"),g=j._Events,i=j._SwfEvents;return b=e?j.initUser(d,f,j.getNick(!0),j.Trinity,h):j.initGuest(d,f,j.Trinity),g&&a.mix(b,{_Events:g}),i&&a.mix(b,{_SwfEvents:i}),a.mix(j,b)}a.version>=1.4&&a.config({modules:{ajax:{alias:["io"]},flash:{alias:["gallery/flash/1.0/"]}}});var j=a.namespace("TBC.umpp");return j.init=i,i()},{requires:["core","tbc/umpp/1.4.36/mods/messenger","tbc/umpp/1.4.36/mods/getNick","tbc/umpp/1.4.36/mods/trinity","tbc/umpp/1.4.36/mods/initGuest","tbc/umpp/1.4.36/mods/initUser","tbc/umpp/1.4.36/mods/monitorevent"]});